<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEU Monitor - Controle de Acesso - Nova</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/smartceu/dashboard/styles.css?v=2">
</head>
<body>
    <div class="dashboard">
        <!-- Menu Lateral -->
        <div class="sidebar">
            <div class="logo">
                <h1>Painel</h1>
            </div>
            <ul class="nav-menu">
                <li><a href="/smartceu/dashboard">Painel Principal</a></li>
                <li><a href="/smartceu/dashboard/controleacesso.html">Controle de Acesso</a></li>
                <li class="active"><a href="/smartceu/dashboard/controledeacessonova.html">Controle de Acesso - Nova</a></li>
                <li><a href="/smartceu/dashboard/areas.html">√Åreas</a></li>
                <li><a href="/smartceu/dashboard/alertas.html">Alertas</a></li>
                <li><a href="/smartceu/dashboard/piscina.html">Piscina</a></li>
                <li style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
                    <a href="/smartceu">‚Üê Voltar ao SmartCEU</a>
                </li>
            </ul>
        </div>

        <!-- Corpo -->
        <div class="main-content">
            <div class="header">
                <h2>Controle de Acesso - Nova</h2>
                <div class="user-info">
                    <span>Administrador</span>
                    <span id="nova-last-update" style="margin-left: 20px; font-size: 0.85em; color: #b0bec5;">
                        <i class="fas fa-sync-alt fa-spin"></i> Carregando...
                    </span>
                </div>
            </div>

            <!-- Cards -->
            <div class="metrics-grid">
                <!-- Card 1: Pessoas no CEU -->
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <i class="fas fa-users"></i> Pessoas no CEU
                        </div>
                    </div>
                    <div class="metric-value" id="nova-current-people">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div class="metric-subvalue" id="nova-capacity-info">Carregando...</div>
                    <span class="metric-status" id="nova-capacity-status">Aguarde...</span>
                </div>

                <!-- Card 2: Entradas Hoje -->
                <div class="metric-card info">
                    <div class="metric-header">
                        <div class="metric-title">
                            <i class="fas fa-sign-in-alt"></i> Entradas Hoje
                        </div>
                    </div>
                    <div class="metric-value" id="nova-entries-today">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div class="metric-subvalue" id="nova-entries-average">M√©dia: --/dia</div>
                    <div class="metric-trend" id="nova-entries-trend">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        <span>Calculando tend√™ncia...</span>
                    </div>
                </div>
            </div>

            <!-- Debug Info -->
            <div style="margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; font-family: monospace; font-size: 12px;">
                <h3 style="margin-top: 0; color: #4fc3f7;">Debug Info</h3>
                <div id="debug-info">Carregando dados...</div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o da API
        const API_BASE = '/smartceu/api/v1/dashboard';
        
        // Fun√ß√£o auxiliar para selecionar elementos
        const $ = (selector) => document.querySelector(selector);
        
        // Fun√ß√£o para buscar estat√≠sticas atuais
        async function fetchCurrentStats() {
            try {
                console.log('üîÑ Buscando stats de:', `${API_BASE}/current-stats`);
                const response = await fetch(`${API_BASE}/current-stats`);
                console.log('üì° Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Dados recebidos:', data);
                return data;
            } catch (error) {
                console.error('‚ùå Erro ao buscar stats:', error);
                return null;
            }
        }
        
        // Fun√ß√£o para buscar estat√≠sticas avan√ßadas
        async function fetchAdvancedStats() {
            try {
                console.log('üîÑ Buscando advanced-stats de:', `${API_BASE}/advanced-stats`);
                const response = await fetch(`${API_BASE}/advanced-stats`);
                console.log('üì° Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Advanced stats recebidos:', data);
                return data;
            } catch (error) {
                console.error('‚ùå Erro ao buscar advanced stats:', error);
                return null;
            }
        }
        
        // Fun√ß√£o para atualizar o Card 1
        function updateCard1(stats) {
            if (!stats) {
                console.error('‚ùå Stats √© null ou undefined');
                $('#debug-info').innerHTML = '<span style="color: #ff8a80;">Erro: Dados n√£o recebidos da API</span>';
                return;
            }
            
            console.log('üé® Atualizando Card 1 com:', stats);
            
            // Atualizar n√∫mero de pessoas
            const peopleEl = $('#nova-current-people');
            peopleEl.textContent = stats.current_people || 0;
            
            // Atualizar capacidade
            const capacityEl = $('#nova-capacity-info');
            capacityEl.textContent = `${stats.current_people || 0} / ${stats.max_capacity || 300} pessoas`;
            
            // Calcular porcentagem
            const percentage = stats.capacity_percentage || 0;
            
            // Atualizar status com cor
            const statusEl = $('#nova-capacity-status');
            if (percentage >= 80) {
                statusEl.textContent = `Capacidade Cr√≠tica (${percentage.toFixed(1)}%)`;
                statusEl.className = 'metric-status status-danger';
            } else if (percentage >= 60) {
                statusEl.textContent = `Capacidade Alta (${percentage.toFixed(1)}%)`;
                statusEl.className = 'metric-status status-warning';
            } else {
                statusEl.textContent = `Capacidade Normal (${percentage.toFixed(1)}%)`;
                statusEl.className = 'metric-status status-success';
            }
            
            // Atualizar indicador de √∫ltima atualiza√ß√£o
            updateLastUpdate(stats.last_reading);
            
            console.log('‚úÖ Card 1 atualizado com sucesso!');
        }
        
        // Fun√ß√£o para atualizar o Card 2
        function updateCard2(advanced) {
            if (!advanced) {
                console.error('‚ùå Advanced stats √© null ou undefined');
                return;
            }
            
            console.log('üé® Atualizando Card 2 com:', advanced);
            
            // Atualizar n√∫mero de entradas
            const entriesEl = $('#nova-entries-today');
            entriesEl.textContent = advanced.entries_today || 0;
            
            // Atualizar m√©dia di√°ria
            const avgEl = $('#nova-entries-average');
            avgEl.textContent = `M√©dia: ${advanced.daily_average || 0}/dia`;
            
            // Atualizar tend√™ncia
            const trendEl = $('#nova-entries-trend');
            const trendPercent = advanced.trend_percentage || 0;
            const trendDirection = advanced.trend_direction || 'stable';
            
            let icon, cssClass, text;
            
            if (trendDirection === 'up') {
                icon = 'fa-arrow-up';
                cssClass = 'trend-up';
                text = `+${Math.abs(trendPercent).toFixed(1)}% em rela√ß√£o a ontem`;
            } else if (trendDirection === 'down') {
                icon = 'fa-arrow-down';
                cssClass = 'trend-down';
                text = `${trendPercent.toFixed(1)}% em rela√ß√£o a ontem`;
            } else {
                icon = 'fa-minus';
                cssClass = '';
                text = 'Est√°vel em rela√ß√£o a ontem';
            }
            
            trendEl.innerHTML = `
                <i class="fas ${icon} ${cssClass}"></i>
                <span>${text}</span>
            `;
            
            console.log('‚úÖ Card 2 atualizado com sucesso!');
        }
        
        // Fun√ß√£o para atualizar indicador de √∫ltima atualiza√ß√£o
        function updateLastUpdate(lastReading) {
            const indicator = $('#nova-last-update');
            if (!indicator) return;
            
            if (!lastReading) {
                indicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sem dados';
                indicator.style.color = '#ff8a80';
                return;
            }
            
            try {
                const date = new Date(lastReading);
                const now = new Date();
                const diffMinutes = Math.floor((now - date) / 1000 / 60);
                
                // Formatar data
                const dia = String(date.getDate()).padStart(2, '0');
                const mes = String(date.getMonth() + 1).padStart(2, '0');
                const ano = date.getFullYear();
                const hora = String(date.getHours()).padStart(2, '0');
                const minuto = String(date.getMinutes()).padStart(2, '0');
                const dataFormatada = `${dia}/${mes}/${ano} ${hora}:${minuto}`;
                
                let icon, color;
                if (diffMinutes < 5) {
                    icon = 'fa-check-circle';
                    color = '#5efc82';
                } else if (diffMinutes < 30) {
                    icon = 'fa-clock';
                    color = '#ffd54f';
                } else {
                    icon = 'fa-exclamation-triangle';
                    color = '#ff8a80';
                }
                
                indicator.innerHTML = `<i class="fas ${icon}"></i> ${dataFormatada}`;
                indicator.style.color = color;
                
                console.log(`‚è∞ √öltima atualiza√ß√£o: ${dataFormatada} (${diffMinutes}min atr√°s)`);
            } catch (error) {
                console.error('‚ùå Erro ao formatar data:', error);
                indicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro na data';
                indicator.style.color = '#ff8a80';
            }
        }
        
        // Fun√ß√£o principal de atualiza√ß√£o
        async function atualizarDados() {
            console.log('üöÄ Iniciando atualiza√ß√£o...');
            
            // Buscar dados das APIs
            const stats = await fetchCurrentStats();
            const advanced = await fetchAdvancedStats();
            
            // Atualizar cards
            updateCard1(stats);
            updateCard2(advanced);
            
            // Atualizar debug info
            if (stats || advanced) {
                let debugHTML = '<strong>Dados das APIs:</strong><br><br>';
                
                if (stats) {
                    debugHTML += '<strong>Current Stats:</strong><br>';
                    debugHTML += `- Pessoas: ${stats.current_people}<br>`;
                    debugHTML += `- Capacidade: ${stats.max_capacity}<br>`;
                    debugHTML += `- Porcentagem: ${stats.capacity_percentage?.toFixed(1)}%<br>`;
                    debugHTML += `- Entradas hoje: ${stats.entries_today}<br>`;
                    debugHTML += `- Sa√≠das hoje: ${stats.exits_today}<br>`;
                    debugHTML += `- √öltima leitura: ${stats.last_reading}<br><br>`;
                }
                
                if (advanced) {
                    debugHTML += '<strong>Advanced Stats:</strong><br>';
                    debugHTML += `- Entradas hoje: ${advanced.entries_today}<br>`;
                    debugHTML += `- Entradas ontem: ${advanced.entries_yesterday}<br>`;
                    debugHTML += `- M√©dia di√°ria: ${advanced.daily_average}<br>`;
                    debugHTML += `- Tend√™ncia: ${advanced.trend_direction} (${advanced.trend_percentage}%)<br>`;
                    debugHTML += `- Previs√£o hoje: ${advanced.today_prediction}<br>`;
                }
                
                $('#debug-info').innerHTML = debugHTML;
            }
        }
        
        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ P√°gina carregada, iniciando...');
            atualizarDados();
            
            // Atualizar a cada 30 segundos
            setInterval(atualizarDados, 30000);
        });
    </script>
</body>
</html>
